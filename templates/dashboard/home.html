{% extends 'base/base.html' %}
{% load dashboard_extras %}

{% block title %}Dashboard - TruK{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>Dashboard</h1>
    <p class="welcome">Bem-vindo, {{ user.get_full_name|default:user.username }}! ğŸš›</p>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“¦</div>
            <div class="stat-info">
                <h3>{{ total_loads }}</h3>
                <p>Total de Cargas</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-info">
                <h3>{{ completed_loads }}</h3>
                <p>ConcluÃ­das</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸšš</div>
            <div class="stat-info">
                <h3>{{ active_loads_count }}</h3>
                <p>Em Andamento</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ›£ï¸</div>
            <div class="stat-info">
                <h3>{{ total_km|compact_number }} km</h3>
                <p>DistÃ¢ncia Total</p>
            </div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-info">
                <h3>â‚¬{{ total_revenue|compact_number }}</h3>
                <p>Receita Total</p>
            </div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-icon">âš ï¸</div>
            <div class="stat-info">
                <h3>â‚¬{{ total_fines|compact_number }}</h3>
                <p>Multas</p>
            </div>
        </div>
        
        <div class="stat-card info">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-info">
                <h3>â‚¬{{ net_revenue|compact_number }}</h3>
                <p>Lucro LÃ­quido</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">â›½</div>
            <div class="stat-info">
                <h3>{{ total_fuel|compact_number }}L</h3>
                <p>CombustÃ­vel</p>
            </div>
        </div>
    </div>
    
    <div class="dashboard-grid">
        <div class="chart-container">
            <h2>Cargas por MÃªs</h2>
            <div id="monthsChart"></div>
        </div>
        
        <div class="recent-loads">
            <h2>Cargas Recentes</h2>
            {% if recent_loads %}
            <ul class="load-list">
                {% for load in recent_loads %}
                <li>
                    <a href="{% url 'loads:detail' load.pk %}">
                        <div class="load-item">
                            <span class="status-badge status-{{ load.status }}">{{ load.get_status_display }}</span>
                            <strong>{{ load.rota }}</strong>
                            <small>{{ load.data_criacao|date:"d/m/Y H:i" }}</small>
                            <span class="load-payment">â‚¬{{ load.pagamento_eur }}</span>
                        </div>
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="empty-state">Nenhuma carga registrada ainda.</p>
            {% endif %}
            <a href="{% url 'loads:list' %}" class="btn btn-secondary btn-block">Ver Todas</a>
        </div>
    </div>
    
    {% if top_routes %}
    <div class="top-routes">
        <h2>Top Rotas</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Rota</th>
                    <th>Entregas</th>
                    <th>Receita Total</th>
                </tr>
            </thead>
            <tbody>
                {% for route in top_routes %}
                <tr>
                    <td>{{ route.origem_cidade }} â†’ {{ route.destino_cidade }}</td>
                    <td>{{ route.count }}</td>
                    <td>â‚¬{{ route.total_revenue|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
    // GrÃ¡fico de cargas por mÃªs
    const monthsData = {{ months_data|safe }};
    const monthsTrace = {
        x: monthsData.map(d => d.month),
        y: monthsData.map(d => d.count),
        type: 'bar',
        marker: { color: '#3498db' }
    };
    
    const monthsLayout = {
        title: '',
        xaxis: { title: 'MÃªs' },
        yaxis: { title: 'NÃºmero de Cargas' }
    };
    
    Plotly.newPlot('monthsChart', [monthsTrace], monthsLayout, {responsive: true});
</script>
{% endblock %}
