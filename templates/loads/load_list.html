{% extends 'base/base.html' %}

{% block title %}Minhas Cargas - TruK{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">Minhas Cargas</h1>
        <p class="text-secondary" style="margin-top: var(--space-2);">
            Gerencie todas as suas cargas registradas
        </p>
    </div>
    <div class="page-actions">
        <a href="{% url 'loads:export_csv' %}?{{ querystring }}" class="btn btn-ghost" title="Exportar para CSV">
            üì• Exportar CSV
        </a>
        <a href="{% url 'loads:create' %}" class="btn btn-primary">
            <span>‚ûï</span> Nova Carga
        </a>
    </div>
</div>

<!-- Filters Card -->
<div class="card load-list-filters">
    <div class="card-body">
        <form method="get" 
              class="load-list-filter-form"
              hx-get="{% url 'loads:list' %}"
              hx-target="#loads-results"
              hx-swap="innerHTML"
              hx-trigger="submit, change from:select delay:300ms"
              hx-push-url="true"
              hx-indicator="#filter-loading">
            <div class="form-group load-list-filter-field">
                <label for="search" class="form-label">Buscar</label>
                <input type="text" 
                       name="search" 
                       id="search" 
                       placeholder="Buscar por rota, carga..." 
                       value="{{ filter_form.search.value|default_if_none:'' }}" 
                       class="form-input"
                       hx-get="{% url 'loads:list' %}"
                       hx-target="#loads-results"
                       hx-swap="innerHTML"
                       hx-trigger="keyup changed delay:500ms"
                       hx-include="closest form"
                       hx-push-url="true">
            </div>
            
            <div class="form-group load-list-filter-field">
                <label for="status" class="form-label">Status</label>
                <select name="status" id="status" class="form-select">
                    {% for value, label in filter_form.fields.status.choices %}
                    <option value="{{ value }}" {% if filter_form.status.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group load-list-filter-field">
                <label for="tipo_trailer" class="form-label">Trailer</label>
                <select name="tipo_trailer" id="tipo_trailer" class="form-select">
                    {% for value, label in filter_form.fields.tipo_trailer.choices %}
                    <option value="{{ value }}" {% if filter_form.tipo_trailer.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group load-list-filter-field">
                <label for="origem_pais" class="form-label">Pa√≠s Origem</label>
                <input type="text" name="origem_pais" id="origem_pais" value="{{ filter_form.origem_pais.value|default_if_none:'' }}" class="form-input">
            </div>

            <div class="form-group load-list-filter-field">
                <label for="destino_pais" class="form-label">Pa√≠s Destino</label>
                <input type="text" name="destino_pais" id="destino_pais" value="{{ filter_form.destino_pais.value|default_if_none:'' }}" class="form-input">
            </div>

            <div class="form-group load-list-filter-field">
                <label for="date_from" class="form-label">Data Inicial</label>
                <input type="date" name="date_from" id="date_from" value="{{ filter_form.date_from.value|default_if_none:'' }}" class="form-input">
            </div>

            <div class="form-group load-list-filter-field">
                <label for="date_to" class="form-label">Data Final</label>
                <input type="date" name="date_to" id="date_to" value="{{ filter_form.date_to.value|default_if_none:'' }}" class="form-input">
            </div>

            <div class="form-group load-list-filter-field">
                <label for="min_payment" class="form-label">Pagamento M√≠n.</label>
                <input type="number" name="min_payment" id="min_payment" step="0.01" value="{{ filter_form.min_payment.value|default_if_none:'' }}" class="form-input">
            </div>

            <div class="form-group load-list-filter-field">
                <label for="max_payment" class="form-label">Pagamento M√°x.</label>
                <input type="number" name="max_payment" id="max_payment" step="0.01" value="{{ filter_form.max_payment.value|default_if_none:'' }}" class="form-input">
            </div>
            
            <button type="submit" class="btn btn-primary load-list-filter-button">
                <span id="filter-loading" class="htmx-indicator">‚è≥</span>
                <span class="filter-btn-text">üîç Filtrar</span>
            </button>
            
            {% if request.GET %}
            <a href="{% url 'loads:list' %}" class="btn btn-ghost load-list-filter-button">
                ‚úï Limpar
            </a>
            {% endif %}
        </form>
    </div>
</div>

<!-- Loads Results (HTMX target) -->
<div id="loads-results">
    {% include 'loads/partials/load_table.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Atualiza link de exporta√ß√£o quando filtros mudam
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'loads-results') {
            const exportLink = document.querySelector('a[href*="export_csv"]');
            if (exportLink) {
                const currentUrl = new URL(window.location.href);
                currentUrl.pathname = '{% url "loads:export_csv" %}';
                exportLink.href = currentUrl.toString();
            }
        }
    });
    
    // Toast de feedback ap√≥s a√ß√µes
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful && evt.detail.target.id === 'loads-results') {
            // Opcionalmente mostrar toast de sucesso
        }
    });
</script>
{% endblock %}
